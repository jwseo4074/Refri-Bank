var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
import React, { useEffect } from 'react';
import { TextField } from '../TextField';
import { makeStyles } from '../../styles';
import clsx from 'clsx';
export var UnitNumberFormatFieldStylesKey = 'ChromaUnitNumberFormatField';
var useStyles = makeStyles(function (theme) { return ({
    textField: {
        marginTop: theme.spacing(2),
        marginBottom: theme.spacing(1),
    },
}); }, { name: UnitNumberFormatFieldStylesKey });
export var UnitNumberFormatField = function (props) {
    var onChange = props.onChange, onBlur = props.onBlur, value = props.value, _a = props.min, min = _a === void 0 ? 0 : _a, _b = props.max, max = _b === void 0 ? Number.MAX_SAFE_INTEGER : _b, units = props.units, _c = props.decimalScale, decimalScale = _c === void 0 ? 0 : _c, _d = props.prefixUnits, prefixUnits = _d === void 0 ? false : _d, className = props.className, other = __rest(props, ["onChange", "onBlur", "value", "min", "max", "units", "decimalScale", "prefixUnits", "className"]);
    // formatting helper. Prefixes units if specified, otherwise suffix.
    // also automatically adds a space if the units string is > 2 e.g $10.00 30%, 12ml, 10 slots
    var format = function (val) {
        return prefixUnits
            ? "" + units + val.toFixed(decimalScale)
            : "" + val.toFixed(decimalScale) + (units.length > 2 ? ' ' : '') + units;
    };
    var _e = React.useState(format(value)), textFieldValue = _e[0], setTextFieldValue = _e[1];
    var classes = useStyles({});
    var _f = React.useState(format(value)), rawValue = _f[0], setRawValue = _f[1];
    // when the text input changes, call onChange handler
    var handleValueChange = function (value) {
        var rawNewValue = value.target.value;
        // user deleted value, set text field value without updating underlying value
        if (rawNewValue.trim() === units) {
            setTextFieldValue(rawNewValue);
            return;
        }
        setRawValue(rawNewValue);
        // default to 0 to handle garbage NaN input
        var newValue = parseFloat((parseFloat(rawNewValue.replace(units, '')) || 0).toFixed(decimalScale));
        setTextFieldValue(format(newValue));
        onChange(newValue);
    };
    // when the provided value changes, update the displayed value
    useEffect(function () {
        setTextFieldValue(format(value));
    }, [value]);
    var textFieldRef = React.useRef(null);
    // This useEffect keeps the position of the cursor from jumping after the value is formatted
    useEffect(function () {
        if (textFieldValue === rawValue || !textFieldRef.current) {
            return;
        }
        // user deleted value, set cursor beside units
        if (textFieldValue.trim() === units) {
            var position_1 = prefixUnits ? units.length : 0;
            textFieldRef.current.setSelectionRange(position_1, position_1);
            return;
        }
        // user typed a decimal next to a decimal, move cursor and throw it away
        if (rawValue.indexOf('..') > -1) {
            var position_2 = textFieldValue.indexOf('.') + 1;
            textFieldRef.current.setSelectionRange(position_2, position_2);
            setRawValue(textFieldValue);
            return;
        }
        // handle positioning cursor when typing in decimal part
        var rawDecimalPart = rawValue.replace(units, '').split('.')[1];
        if (decimalScale > 0 &&
            rawDecimalPart &&
            rawDecimalPart.length > decimalScale) {
            var rawNumberParts = ("" + parseFloat(textFieldValue.replace(units, '')).toFixed(decimalScale)).split('.');
            var decimalPart = rawNumberParts[1].replace(/0+$/g, ''); // trim trailing 0s
            var position_3 = rawNumberParts[0].length + // length before decimal
                1 + // the decimal
                Math.max(decimalPart.length, 1) + // at least one character after decimal
                (prefixUnits ? units.length : 0); // length of units, if they're prefixed
            textFieldRef.current.setSelectionRange(position_3, position_3);
            setRawValue(textFieldValue);
            return;
        }
        var position = ("" + parseFloat(textFieldValue.replace(units, ''))).length +
            (prefixUnits ? units.length : 0);
        textFieldRef.current.setSelectionRange(position, position);
        setRawValue(textFieldValue);
    }, [textFieldValue, rawValue]);
    // handles selecting just the value (not the units) on focus
    var handleFocus = React.useCallback(function () {
        /* istanbul ignore next */
        if (!textFieldRef.current) {
            return;
        }
        var inputLength = textFieldValue.replace(units, '').length;
        var inputStart = prefixUnits ? units.length : 0;
        // focus can only fire if the input ref has been set
        textFieldRef.current.setSelectionRange(inputStart, inputStart + inputLength);
    }, [textFieldValue]);
    // if the user deleted value and left only units, this restores the text field to valid value
    var handleBlur = function (event) {
        var newValue = parseFloat(Math.max(Math.min(parseFloat(rawValue.replace(units, '')), Number(max)), min).toFixed(decimalScale));
        setTextFieldValue(format(newValue));
        onChange(newValue);
        onBlur && onBlur(event);
    };
    return (React.createElement(TextField, __assign({}, other, { className: clsx(classes.textField, className), value: textFieldValue, min: min, max: max, onChange: handleValueChange, onFocus: handleFocus, onBlur: handleBlur, ref: textFieldRef })));
};
export var PercentFormatField = function (props) {
    return (React.createElement(UnitNumberFormatField, __assign({}, props, { units: '%', max: props.max || 100 })));
};
export var PriceFormatField = function (props) {
    var value = props.value, onChange = props.onChange, min = props.min, max = props.max, otherProps = __rest(props, ["value", "onChange", "min", "max"]);
    if (!Number.isInteger(value) ||
        (min && !Number.isInteger(min)) ||
        (max && !Number.isInteger(max))) {
        throw new Error('Non-integer amount of pennies passed to PriceFormatField');
    }
    return (React.createElement(UnitNumberFormatField, __assign({ value: value / 100, onChange: function (val) { return onChange(val * 100); }, min: min ? min / 100 : undefined, max: max ? max / 100 : undefined }, otherProps, { prefixUnits: true, units: '$', decimalScale: 2 })));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVW5pdE51bWJlckZvcm1hdEZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvTnVtYmVyRm9ybWF0L1VuaXROdW1iZXJGb3JtYXRGaWVsZC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQWUsU0FBUyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQ3RELE9BQU8sRUFBa0IsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRXpELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBR3hCLE1BQU0sQ0FBQyxJQUFNLDhCQUE4QixHQUFHLDZCQUE2QixDQUFDO0FBRTVFLElBQU0sU0FBUyxHQUFHLFVBQVUsQ0FDMUIsVUFBQyxLQUFLLElBQUssT0FBQSxDQUFDO0lBQ1YsU0FBUyxFQUFFO1FBQ1QsU0FBUyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzNCLFlBQVksRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUMvQjtDQUNGLENBQUMsRUFMUyxDQUtULEVBQ0YsRUFBRSxJQUFJLEVBQUUsOEJBQThCLEVBQUUsQ0FDekMsQ0FBQztBQWlCRixNQUFNLENBQUMsSUFBTSxxQkFBcUIsR0FBeUMsVUFDekUsS0FBSztJQUdILElBQUEseUJBQVEsRUFDUixxQkFBTSxFQUNOLG1CQUFLLEVBQ0wsY0FBTyxFQUFQLDRCQUFPLEVBQ1AsY0FBNkIsRUFBN0Isa0RBQTZCLEVBQzdCLG1CQUFLLEVBQ0wsdUJBQWdCLEVBQWhCLHFDQUFnQixFQUNoQixzQkFBbUIsRUFBbkIsd0NBQW1CLEVBQ25CLDJCQUFTLEVBQ1QseUhBQVEsQ0FDQTtJQUNWLG9FQUFvRTtJQUNwRSw0RkFBNEY7SUFDNUYsSUFBTSxNQUFNLEdBQUcsVUFBQyxH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Q0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQzVCLFVBQVUsSUFDZCxXQUFXLEVBQUUsSUFBSSxFQUNqQixLQUFLLEVBQUUsR0FBRyxFQUNWLFlBQVksRUFBRSxDQUFDLElBQ2YsQ0FDSCxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IENoYW5nZUV2ZW50LCB1c2VFZmZlY3QgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBUZXh0RmllbGRQcm9wcywgVGV4dEZpZWxkIH0gZnJvbSAnLi4vVGV4dEZpZWxkJztcblxuaW1wb3J0IHsgbWFrZVN0eWxlcyB9IGZyb20gJy4uLy4uL3N0eWxlcyc7XG5pbXBvcnQgY2xzeCBmcm9tICdjbHN4JztcbmltcG9ydCB7IEdldENsYXNzZXMgfSBmcm9tICcuLi8uLi90eXBlVXRpbHMnO1xuXG5leHBvcnQgY29uc3QgVW5pdE51bWJlckZvcm1hdEZpZWxkU3R5bGVzS2V5ID0gJ0Nocm9tYVVuaXROdW1iZXJGb3JtYXRGaWVsZCc7XG5cbmNvbnN0IHVzZVN0eWxlcyA9IG1ha2VTdHlsZXMoXG4gICh0aGVtZSkgPT4gKHtcbiAgICB0ZXh0RmllbGQ6IHtcbiAgICAgIG1hcmdpblRvcDogdGhlbWUuc3BhY2luZygyKSxcbiAgICAgIG1hcmdpbkJvdHRvbTogdGhlbWUuc3BhY2luZygxKSxcbiAgICB9LFxuICB9KSxcbiAgeyBuYW1lOiBVbml0TnVtYmVyRm9ybWF0RmllbGRTdHlsZXNLZXkgfVxuKTtcblxuZXhwb3J0IHR5cGUgVW5pdE51bWJlckZvcm1hdEZpZWxkQ2xhc3NlcyA9IEdldENsYXNzZXM8dHlwZW9mIHVzZVN0eWxlcz47XG5cbmV4cG9ydCB0eXBlIFVuaXROdW1iZXJGb3JtYXRGaWVsZFByb3BzID0gT21pdDxcbiAgVGV4dEZpZWxkUHJvcHMsXG4gICdvbkNoYW5nZScgfCAndmFsdWUnXG4+ICYge1xuICBtaW4/OiBudW1iZXI7XG4gIG1heD86IG51bWJlcjtcbiAgdmFsdWU6IG51bWJlcjtcbiAgdW5pdHM6IHN0cmluZztcbiAgZGVjaW1hbFNjYWxlPzogbnVtYmVyO1xuICBwcmVmaXhVbml0cz86IGJvb2xlYW47XG4gIG9uQ2hhbmdlOiAodmFsOiBudW1iZXIpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgY29uc3QgVW5pdE51bWJlckZvcm1hdEZpZWxkOiBSZWFjdC5GQzxVbml0TnVtYmVyRm9ybWF0RmllbGRQcm9wcz4gPSAoXG4gIHByb3BzXG4pID0+IHtcbiAgY29uc3Qge1xuICAgIG9uQ2hhbmdlLFxuICAgIG9uQmx1cixcbiAgICB2YWx1ZSxcbiAgICBtaW4gPSAwLFxuICAgIG1heCA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSLFxuICAgIHVuaXRzLFxuICAgIGRlY2ltYWxTY2FsZSA9IDAsXG4gICAgcHJlZml4VW5pdHMgPSBmYWxzZSxcbiAgICBjbGFzc05hbWUsXG4gICAgLi4ub3RoZXJcbiAgfSA9IHByb3BzO1xuICAvLyBmb3JtYXR0aW5nIGhlbHBlci4gUHJlZml4ZXMgdW5pdHMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugc3VmZml4LlxuICAvLyBhbHNvIGF1dG9tYXRpY2FsbHkgYWRkcyBhIHNwYWNlIGlmIHRoZSB1bml0cyBzdHJpbmcgaXMgPiAyIGUuZyAkMTAuMDAgMzAlLCAxMm1sLCAxMCBzbG90c1xuICBjb25zdCBmb3JtYXQgPSAodmFsOiBudW1iZXIpID0+XG4gICAgcHJlZml4VW5pdHNcbiAgICAgID8gYCR7dW5pdHN9JHt2YWwudG9GaXhlZChkZWNpbWFsU2NhbGUpfWBcbiAgICAgIDogYCR7dmFsLnRvRml4ZWQoZGVjaW1hbFNjYWxlKX0ke3VuaXRzLmxlbmd0aCA+IDIgPyAnICcgOiAnJ30ke3VuaXRzfWA7XG4gIGNvbnN0IFt0ZXh0RmllbGRWYWx1ZSwgc2V0VGV4dEZpZWxkVmFsdWVdID0gUmVhY3QudXNlU3RhdGUoZm9ybWF0KHZhbHVlKSk7XG5cbiAgY29uc3QgY2xhc3NlcyA9IHVzZVN0eWxlcyh7fSk7XG5cbiAgY29uc3QgW3Jhd1ZhbHVlLCBzZXRSYXdWYWx1ZV0gPSBSZWFjdC51c2VTdGF0ZShmb3JtYXQodmFsdWUpKTtcblxuICAvLyB3aGVuIHRoZSB0ZXh0IGlucHV0IGNoYW5nZXMsIGNhbGwgb25DaGFuZ2UgaGFuZGxlclxuICBjb25zdCBoYW5kbGVWYWx1ZUNoYW5nZSA9ICh2YWx1ZTogQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICBjb25zdCByYXdOZXdWYWx1ZSA9IHZhbHVlLnRhcmdldC52YWx1ZTtcblxuICAgIC8vIHVzZXIgZGVsZXRlZCB2YWx1ZSwgc2V0IHRleHQgZmllbGQgdmFsdWUgd2l0aG91dCB1cGRhdGluZyB1bmRlcmx5aW5nIHZhbHVlXG4gICAgaWYgKHJhd05ld1ZhbHVlLnRyaW0oKSA9PT0gdW5pdHMpIHtcbiAgICAgIHNldFRleHRGaWVsZFZhbHVlKHJhd05ld1ZhbHVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBzZXRSYXdWYWx1ZShyYXdOZXdWYWx1ZSk7XG5cbiAgICAvLyBkZWZhdWx0IHRvIDAgdG8gaGFuZGxlIGdhcmJhZ2UgTmFOIGlucHV0XG4gICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZsb2F0KFxuICAgICAgKHBhcnNlRmxvYXQocmF3TmV3VmFsdWUucmVwbGFjZSh1bml0cywgJycpKSB8fCAwKS50b0ZpeGVkKGRlY2ltYWxTY2FsZSlcbiAgICApO1xuICAgIHNldFRleHRGaWVsZFZhbHVlKGZvcm1hdChuZXdWYWx1ZSkpO1xuICAgIG9uQ2hhbmdlKG5ld1ZhbHVlKTtcbiAgfTtcblxuICAvLyB3aGVuIHRoZSBwcm92aWRlZCB2YWx1ZSBjaGFuZ2VzLCB1cGRhdGUgdGhlIGRpc3BsYXllZCB2YWx1ZVxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIHNldFRleHRGaWVsZFZhbHVlKGZvcm1hdCh2YWx1ZSkpO1xuICB9LCBbdmFsdWVdKTtcblxuICBjb25zdCB0ZXh0RmllbGRSZWYgPSBSZWFjdC51c2VSZWY8SFRNTElucHV0RWxlbWVudCB8IG51bGw+KG51bGwpO1xuXG4gIC8vIFRoaXMgdXNlRWZmZWN0IGtlZXBzIHRoZSBwb3NpdGlvbiBvZiB0aGUgY3Vyc29yIGZyb20ganVtcGluZyBhZnRlciB0aGUgdmFsdWUgaXMgZm9ybWF0dGVkXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKHRleHRGaWVsZFZhbHVlID09PSByYXdWYWx1ZSB8fCAhdGV4dEZpZWxkUmVmLmN1cnJlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB1c2VyIGRlbGV0ZWQgdmFsdWUsIHNldCBjdXJzb3IgYmVzaWRlIHVuaXRzXG4gICAgaWYgKHRleHRGaWVsZFZhbHVlLnRyaW0oKSA9PT0gdW5pdHMpIHtcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcHJlZml4VW5pdHMgPyB1bml0cy5sZW5ndGggOiAwO1xuICAgICAgdGV4dEZpZWxkUmVmLmN1cnJlbnQuc2V0U2VsZWN0aW9uUmFuZ2UocG9zaXRpb24sIHBvc2l0aW9uKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB1c2VyIHR5cGVkIGEgZGVjaW1hbCBuZXh0IHRvIGEgZGVjaW1hbCwgbW92ZSBjdXJzb3IgYW5kIHRocm93IGl0IGF3YXlcbiAgICBpZiAocmF3VmFsdWUuaW5kZXhPZignLi4nKSA+IC0xKSB7XG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHRleHRGaWVsZFZhbHVlLmluZGV4T2YoJy4nKSArIDE7XG4gICAgICB0ZXh0RmllbGRSZWYuY3VycmVudC5zZXRTZWxlY3Rpb25SYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pO1xuICAgICAgc2V0UmF3VmFsdWUodGV4dEZpZWxkVmFsdWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGhhbmRsZSBwb3NpdGlvbmluZyBjdXJzb3Igd2hlbiB0eXBpbmcgaW4gZGVjaW1hbCBwYXJ0XG4gICAgY29uc3QgcmF3RGVjaW1hbFBhcnQgPSByYXdWYWx1ZS5yZXBsYWNlKHVuaXRzLCAnJykuc3BsaXQoJy4nKVsxXTtcbiAgICBpZiAoXG4gICAgICBkZWNpbWFsU2NhbGUgPiAwICYmXG4gICAgICByYXdEZWNpbWFsUGFydCAmJlxuICAgICAgcmF3RGVjaW1hbFBhcnQubGVuZ3RoID4gZGVjaW1hbFNjYWxlXG4gICAgKSB7XG4gICAgICBjb25zdCByYXdOdW1iZXJQYXJ0cyA9IGAke3BhcnNlRmxvYXQoXG4gICAgICAgIHRleHRGaWVsZFZhbHVlLnJlcGxhY2UodW5pdHMsICcnKVxuICAgICAgKS50b0ZpeGVkKGRlY2ltYWxTY2FsZSl9YC5zcGxpdCgnLicpO1xuICAgICAgY29uc3QgZGVjaW1hbFBhcnQgPSByYXdOdW1iZXJQYXJ0c1sxXS5yZXBsYWNlKC8wKyQvZywgJycpOyAvLyB0cmltIHRyYWlsaW5nIDBzXG4gICAgICBjb25zdCBwb3NpdGlvbiA9XG4gICAgICAgIHJhd051bWJlclBhcnRzWzBdLmxlbmd0aCArIC8vIGxlbmd0aCBiZWZvcmUgZGVjaW1hbFxuICAgICAgICAxICsgLy8gdGhlIGRlY2ltYWxcbiAgICAgICAgTWF0aC5tYXgoZGVjaW1hbFBhcnQubGVuZ3RoLCAxKSArIC8vIGF0IGxlYXN0IG9uZSBjaGFyYWN0ZXIgYWZ0ZXIgZGVjaW1hbFxuICAgICAgICAocHJlZml4VW5pdHMgPyB1bml0cy5sZW5ndGggOiAwKTsgLy8gbGVuZ3RoIG9mIHVuaXRzLCBpZiB0aGV5J3JlIHByZWZpeGVkXG4gICAgICB0ZXh0RmllbGRSZWYuY3VycmVudC5zZXRTZWxlY3Rpb25SYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pO1xuICAgICAgc2V0UmF3VmFsdWUodGV4dEZpZWxkVmFsdWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHBvc2l0aW9uID1cbiAgICAgIGAke3BhcnNlRmxvYXQodGV4dEZpZWxkVmFsdWUucmVwbGFjZSh1bml0cywgJycpKX1gLmxlbmd0aCArXG4gICAgICAocHJlZml4VW5pdHMgPyB1bml0cy5sZW5ndGggOiAwKTtcbiAgICB0ZXh0RmllbGRSZWYuY3VycmVudC5zZXRTZWxlY3Rpb25SYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pO1xuICAgIHNldFJhd1ZhbHVlKHRleHRGaWVsZFZhbHVlKTtcbiAgfSwgW3RleHRGaWVsZFZhbHVlLCByYXdWYWx1ZV0pO1xuXG4gIC8vIGhhbmRsZXMgc2VsZWN0aW5nIGp1c3QgdGhlIHZhbHVlIChub3QgdGhlIHVuaXRzKSBvbiBmb2N1c1xuICBjb25zdCBoYW5kbGVGb2N1cyA9IFJlYWN0LnVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIGlmICghdGV4dEZpZWxkUmVmLmN1cnJlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaW5wdXRMZW5ndGggPSB0ZXh0RmllbGRWYWx1ZS5yZXBsYWNlKHVuaXRzLCAnJykubGVuZ3RoO1xuICAgIGNvbnN0IGlucHV0U3RhcnQgPSBwcmVmaXhVbml0cyA/IHVuaXRzLmxlbmd0aCA6IDA7XG5cbiAgICAvLyBmb2N1cyBjYW4gb25seSBmaXJlIGlmIHRoZSBpbnB1dCByZWYgaGFzIGJlZW4gc2V0XG4gICAgdGV4dEZpZWxkUmVmLmN1cnJlbnQuc2V0U2VsZWN0aW9uUmFuZ2UoXG4gICAgICBpbnB1dFN0YXJ0LFxuICAgICAgaW5wdXRTdGFydCArIGlucHV0TGVuZ3RoXG4gICAgKTtcbiAgfSwgW3RleHRGaWVsZFZhbHVlXSk7XG5cbiAgLy8gaWYgdGhlIHVzZXIgZGVsZXRlZCB2YWx1ZSBhbmQgbGVmdCBvbmx5IHVuaXRzLCB0aGlzIHJlc3RvcmVzIHRoZSB0ZXh0IGZpZWxkIHRvIHZhbGlkIHZhbHVlXG4gIGNvbnN0IGhhbmRsZUJsdXIgPSAoZXZlbnQ6IFJlYWN0LkZvY3VzRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlRmxvYXQoXG4gICAgICBNYXRoLm1heChcbiAgICAgICAgTWF0aC5taW4ocGFyc2VGbG9hdChyYXdWYWx1ZS5yZXBsYWNlKHVuaXRzLCAnJykpLCBOdW1iZXIobWF4KSksXG4gICAgICAgIG1pblxuICAgICAgKS50b0ZpeGVkKGRlY2ltYWxTY2FsZSlcbiAgICApO1xuICAgIHNldFRleHRGaWVsZFZhbHVlKGZvcm1hdChuZXdWYWx1ZSkpO1xuICAgIG9uQ2hhbmdlKG5ld1ZhbHVlKTtcbiAgICBvbkJsdXIgJiYgb25CbHVyKGV2ZW50KTtcbiAgfTtcblxuICByZXR1cm4gKFxuICAgIDxUZXh0RmllbGRcbiAgICAgIHsuLi5vdGhlcn1cbiAgICAgIGNsYXNzTmFtZT17Y2xzeChjbGFzc2VzLnRleHRGaWVsZCwgY2xhc3NOYW1lKX1cbiAgICAgIHZhbHVlPXt0ZXh0RmllbGRWYWx1ZX1cbiAgICAgIG1pbj17bWlufVxuICAgICAgbWF4PXttYXh9XG4gICAgICBvbkNoYW5nZT17aGFuZGxlVmFsdWVDaGFuZ2V9XG4gICAgICBvbkZvY3VzPXtoYW5kbGVGb2N1c31cbiAgICAgIG9uQmx1cj17aGFuZGxlQmx1cn1cbiAgICAgIHJlZj17dGV4dEZpZWxkUmVmfVxuICAgIC8+XG4gICk7XG59O1xuXG5leHBvcnQgdHlwZSBQZXJjZW50Rm9ybWF0RmllbGRQcm9wcyA9IE9taXQ8XG4gIFRleHRGaWVsZFByb3BzLFxuICAnb25DaGFuZ2UnIHwgJ3ZhbHVlJ1xuPiAmIHtcbiAgbWluPzogbnVtYmVyO1xuICBtYXg/OiBudW1iZXI7XG4gIHZhbHVlOiBudW1iZXI7XG4gIG9uQ2hhbmdlOiAodmFsOiBudW1iZXIpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgY29uc3QgUGVyY2VudEZvcm1hdEZpZWxkOiBSZWFjdC5GQzxQZXJjZW50Rm9ybWF0RmllbGRQcm9wcz4gPSAoXG4gIHByb3BzXG4pID0+IHtcbiAgcmV0dXJuIChcbiAgICA8VW5pdE51bWJlckZvcm1hdEZpZWxkIHsuLi5wcm9wc30gdW5pdHM9eyclJ30gbWF4PXtwcm9wcy5tYXggfHwgMTAwfSAvPlxuICApO1xufTtcblxuLyoqXG4gKiBAcGFyYW0gcHJvcHMgQWxsIGN1cnJlbmN5IHZhbHVlcyBhcmUgZXhwZWN0ZWQgdG8gYmUgYW4gaW50ZWdlciBhbW91bnQgb2YgcGVubmllc1xuICovXG5cbmV4cG9ydCB0eXBlIFByaWNlRm9ybWF0RmllbGRQcm9wcyA9IE9taXQ8XG4gIFRleHRGaWVsZFByb3BzLFxuICAnb25DaGFuZ2UnIHwgJ3ZhbHVlJ1xuPiAmIHtcbiAgbWluPzogbnVtYmVyO1xuICBtYXg/OiBudW1iZXI7XG4gIHZhbHVlOiBudW1iZXI7XG4gIG9uQ2hhbmdlOiAodmFsOiBudW1iZXIpID0+IHZvaWQ7XG59O1xuZXhwb3J0IGNvbnN0IFByaWNlRm9ybWF0RmllbGQ6IFJlYWN0LkZDPFByaWNlRm9ybWF0RmllbGRQcm9wcz4gPSAocHJvcHMpID0+IHtcbiAgY29uc3QgeyB2YWx1ZSwgb25DaGFuZ2UsIG1pbiwgbWF4LCAuLi5vdGhlclByb3BzIH0gPSBwcm9wcztcbiAgaWYgKFxuICAgICFOdW1iZXIuaXNJbnRlZ2VyKHZhbHVlKSB8fFxuICAgIChtaW4gJiYgIU51bWJlci5pc0ludGVnZXIobWluKSkgfHxcbiAgICAobWF4ICYmICFOdW1iZXIuaXNJbnRlZ2VyKG1heCkpXG4gICkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm9uLWludGVnZXIgYW1vdW50IG9mIHBlbm5pZXMgcGFzc2VkIHRvIFByaWNlRm9ybWF0RmllbGQnKTtcbiAgfVxuICByZXR1cm4gKFxuICAgIDxVbml0TnVtYmVyRm9ybWF0RmllbGRcbiAgICAgIHZhbHVlPXt2YWx1ZSAvIDEwMH0gLy8gVmFsdWUgaW4gcGVubmllcyBjb252ZXJ0ZWQgdG8gZG9sbGFyc1xuICAgICAgb25DaGFuZ2U9eyh2YWwpID0+IG9uQ2hhbmdlKHZhbCAqIDEwMCl9IC8vIERvbGxhciBjb252ZXJ0ZWQgdG8gZXhwZWN0ZWQgcGVubmllc1xuICAgICAgbWluPXttaW4gPyBtaW4gLyAxMDAgOiB1bmRlZmluZWR9IC8vIE1pbiBpbiBwZW5uaWVzIGNvbnZlcnRlZCB0byBkb2xsYXJzXG4gICAgICBtYXg9e21heCA/IG1heCAvIDEwMCA6IHVuZGVmaW5lZH0gLy8gTWF4IGluIHBlbm5pZXMgY29udmVydGVkIHRvIGRvbGxhcnNcbiAgICAgIHsuLi5vdGhlclByb3BzfVxuICAgICAgcHJlZml4VW5pdHM9e3RydWV9XG4gICAgICB1bml0cz17JyQnfVxuICAgICAgZGVjaW1hbFNjYWxlPXsyfVxuICAgIC8+XG4gICk7XG59O1xuIl19