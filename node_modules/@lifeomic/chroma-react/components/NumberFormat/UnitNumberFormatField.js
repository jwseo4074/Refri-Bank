"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PriceFormatField = exports.PercentFormatField = exports.UnitNumberFormatField = exports.UnitNumberFormatFieldStylesKey = void 0;
var react_1 = __importStar(require("react"));
var TextField_1 = require("../TextField");
var styles_1 = require("../../styles");
var clsx_1 = __importDefault(require("clsx"));
exports.UnitNumberFormatFieldStylesKey = 'ChromaUnitNumberFormatField';
var useStyles = (0, styles_1.makeStyles)(function (theme) { return ({
    textField: {
        marginTop: theme.spacing(2),
        marginBottom: theme.spacing(1),
    },
}); }, { name: exports.UnitNumberFormatFieldStylesKey });
var UnitNumberFormatField = function (props) {
    var onChange = props.onChange, onBlur = props.onBlur, value = props.value, _a = props.min, min = _a === void 0 ? 0 : _a, _b = props.max, max = _b === void 0 ? Number.MAX_SAFE_INTEGER : _b, units = props.units, _c = props.decimalScale, decimalScale = _c === void 0 ? 0 : _c, _d = props.prefixUnits, prefixUnits = _d === void 0 ? false : _d, className = props.className, other = __rest(props, ["onChange", "onBlur", "value", "min", "max", "units", "decimalScale", "prefixUnits", "className"]);
    // formatting helper. Prefixes units if specified, otherwise suffix.
    // also automatically adds a space if the units string is > 2 e.g $10.00 30%, 12ml, 10 slots
    var format = function (val) {
        return prefixUnits
            ? "".concat(units).concat(val.toFixed(decimalScale))
            : "".concat(val.toFixed(decimalScale)).concat(units.length > 2 ? ' ' : '').concat(units);
    };
    var _e = react_1.default.useState(format(value)), textFieldValue = _e[0], setTextFieldValue = _e[1];
    var classes = useStyles({});
    var _f = react_1.default.useState(format(value)), rawValue = _f[0], setRawValue = _f[1];
    // when the text input changes, call onChange handler
    var handleValueChange = function (value) {
        var rawNewValue = value.target.value;
        // user deleted value, set text field value without updating underlying value
        if (rawNewValue.trim() === units) {
            setTextFieldValue(rawNewValue);
            return;
        }
        setRawValue(rawNewValue);
        // default to 0 to handle garbage NaN input
        var newValue = parseFloat((parseFloat(rawNewValue.replace(units, '')) || 0).toFixed(decimalScale));
        setTextFieldValue(format(newValue));
        onChange(newValue);
    };
    // when the provided value changes, update the displayed value
    (0, react_1.useEffect)(function () {
        setTextFieldValue(format(value));
    }, [value]);
    var textFieldRef = react_1.default.useRef(null);
    // This useEffect keeps the position of the cursor from jumping after the value is formatted
    (0, react_1.useEffect)(function () {
        if (textFieldValue === rawValue || !textFieldRef.current) {
            return;
        }
        // user deleted value, set cursor beside units
        if (textFieldValue.trim() === units) {
            var position_1 = prefixUnits ? units.length : 0;
            textFieldRef.current.setSelectionRange(position_1, position_1);
            return;
        }
        // user typed a decimal next to a decimal, move cursor and throw it away
        if (rawValue.indexOf('..') > -1) {
            var position_2 = textFieldValue.indexOf('.') + 1;
            textFieldRef.current.setSelectionRange(position_2, position_2);
            setRawValue(textFieldValue);
            return;
        }
        // handle positioning cursor when typing in decimal part
        var rawDecimalPart = rawValue.replace(units, '').split('.')[1];
        if (decimalScale > 0 &&
            rawDecimalPart &&
            rawDecimalPart.length > decimalScale) {
            var rawNumberParts = "".concat(parseFloat(textFieldValue.replace(units, '')).toFixed(decimalScale)).split('.');
            var decimalPart = rawNumberParts[1].replace(/0+$/g, ''); // trim trailing 0s
            var position_3 = rawNumberParts[0].length + // length before decimal
                1 + // the decimal
                Math.max(decimalPart.length, 1) + // at least one character after decimal
                (prefixUnits ? units.length : 0); // length of units, if they're prefixed
            textFieldRef.current.setSelectionRange(position_3, position_3);
            setRawValue(textFieldValue);
            return;
        }
        var position = "".concat(parseFloat(textFieldValue.replace(units, ''))).length +
            (prefixUnits ? units.length : 0);
        textFieldRef.current.setSelectionRange(position, position);
        setRawValue(textFieldValue);
    }, [textFieldValue, rawValue]);
    // handles selecting just the value (not the units) on focus
    var handleFocus = react_1.default.useCallback(function () {
        /* istanbul ignore next */
        if (!textFieldRef.current) {
            return;
        }
        var inputLength = textFieldValue.replace(units, '').length;
        var inputStart = prefixUnits ? units.length : 0;
        // focus can only fire if the input ref has been set
        textFieldRef.current.setSelectionRange(inputStart, inputStart + inputLength);
    }, [textFieldValue]);
    // if the user deleted value and left only units, this restores the text field to valid value
    var handleBlur = function (event) {
        var newValue = parseFloat(Math.max(Math.min(parseFloat(rawValue.replace(units, '')), Number(max)), min).toFixed(decimalScale));
        setTextFieldValue(format(newValue));
        onChange(newValue);
        onBlur && onBlur(event);
    };
    return (react_1.default.createElement(TextField_1.TextField, __assign({}, other, { className: (0, clsx_1.default)(classes.textField, className), value: textFieldValue, min: min, max: max, onChange: handleValueChange, onFocus: handleFocus, onBlur: handleBlur, ref: textFieldRef })));
};
exports.UnitNumberFormatField = UnitNumberFormatField;
var PercentFormatField = function (props) {
    return (react_1.default.createElement(exports.UnitNumberFormatField, __assign({}, props, { units: '%', max: props.max || 100 })));
};
exports.PercentFormatField = PercentFormatField;
var PriceFormatField = function (props) {
    var value = props.value, onChange = props.onChange, min = props.min, max = props.max, otherProps = __rest(props, ["value", "onChange", "min", "max"]);
    if (!Number.isInteger(value) ||
        (min && !Number.isInteger(min)) ||
        (max && !Number.isInteger(max))) {
        throw new Error('Non-integer amount of pennies passed to PriceFormatField');
    }
    return (react_1.default.createElement(exports.UnitNumberFormatField, __assign({ value: value / 100, onChange: function (val) { return onChange(val * 100); }, min: min ? min / 100 : undefined, max: max ? max / 100 : undefined }, otherProps, { prefixUnits: true, units: '$', decimalScale: 2 })));
};
exports.PriceFormatField = PriceFormatField;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVW5pdE51bWJlckZvcm1hdEZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvTnVtYmVyRm9ybWF0L1VuaXROdW1iZXJGb3JtYXRGaWVsZC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNkNBQXNEO0FBQ3RELDBDQUF5RDtBQUV6RCx1Q0FBMEM7QUFDMUMsOENBQXdCO0FBR1gsUUFBQSw4QkFBOEIsR0FBRyw2QkFBNkIsQ0FBQztBQUU1RSxJQUFNLFNBQVMsR0FBRyxJQUFBLG1CQUFVLEVBQzFCLFVBQUMsS0FBSyxJQUFLLE9BQUEsQ0FBQztJQUNWLFNBQVMsRUFBRTtRQUNULFNBQVMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMzQixZQUFZLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7S0FDL0I7Q0FDRixDQUFDLEVBTFMsQ0FLVCxFQUNGLEVBQUUsSUFBSSxFQUFFLHNDQUE4QixFQUFFLENBQ3pDLENBQUM7QUFpQkssSUFBTSxxQkFBcUIsR0FBeUMsVUFDekUsS0FBSztJQUdILElBQUEsUUFBUSxHQVVOLEtBQUssU0FWQyxFQUNSLE1BQU0sR0FTSixLQUFLLE9BVEQsRUFDTixLQUFLLEdBUUgsS0FBSyxNQVJGLEVBQ0wsS0FPRSxLQUFLLElBUEEsRUFBUCxHQUFHLG1CQUFHLENBQUMsS0FBQSxFQUNQLEtBTUUsS0FBSyxJQU5zQixFQUE3QixHQUFHLG1CQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsS0FBQSxFQUM3QixLQUFLLEdBS0gsS0FBSyxNQUxGLEVBQ0wsS0FJRSxLQUFLLGFBSlMsRUFBaEIsWUFBWSxtQkFBRyxDQUFDLEtBQUEsRUFDaEIsS0FHRSxLQUFLLFlBSFksRUFBbkIsV0FBVyxtQkFBRyxLQUFLLEtBQUEsRUFDbkIsU0FBUyxHQUVQLEtBQUssVUFGRSxFQUNOLEtBQUssVUFDTixLQUFLLEVBWEgsa0dBV0wsQ0FEUyxDQUNBO0lBQ1Ysb0VBQW9FO0lBQ3BFLDRGQUE0RjtJQUM1RixJQUFNLE1BQU0sR0FBRyxVQUFDLEdBQVc7UUFDekIsT0FBQSxXQUFXO1lBQ1QsQ0FBQyxDQUFDLFVBQUcsS0FBSyxTQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUU7WUFDeEMsQ0FBQyxDQUFDLFVBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBRyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLFNBQUcsS0FBSyxDQUFFO0lBRnhFLENBRXdFLENBQUM7SUFDckUsSUFBQSxLQUFzQyxlQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFsRSxjQUFjLFFBQUEsRUFBRSxpQkFBaUIsUUFBaUMsQ0FBQztJQUUxRSxJQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFeEIsSUFBQSxLQUEwQixlQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUF0RCxRQUFRLFFBQUEsRUFBRSxXQUFXLFFBQWlDLENBQUM7SUFFOUQscURBQXFEO0lBQ3JELElBQU0saUJBQWlCLEdBQUcsVUFBQyxLQUFvQztRQUM3RCxJQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUV2Qyw2RUFBNkU7UUFDN0UsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssS0FBSyxFQUFFO1lBQ2hDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQy9CLE9BQU87U0FDUjtRQUVELFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV6QiwyQ0FBMkM7UUFDM0MsSUFBTSxRQUFRLEdBQUcsVUFBVSxDQUN6QixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FDeEUsQ0FBQztRQUNGLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNyQixDQUFDLENBQUM7SUFFRiw4REFBOEQ7SUFDOUQsSUFBQSxpQkFBUyxFQUFDO1FBQ1IsaUJBQWlCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDbkMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUVaLElBQU0sWUFBWSxHQUFHLGVBQUssQ0FBQyxNQUFNLENBQTBCLElBQUksQ0FBQyxDQUFDO0lBRWpFLDRGQUE0RjtJQUM1RixJQUFBLGlCQUFTLEVBQUM7UUFDUixJQUFJLGNBQWMsS0FBSyxRQUFRLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFO1lBQ3hELE9BQU87U0FDUjtRQUVELDhDQUE4QztRQUM5QyxJQUFJLGNBQWMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxLQUFLLEVBQUU7WUFDbkMsSUFBTSxVQUFRLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEQsWUFBWSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxVQUFRLEVBQUUsVUFBUSxDQUFDLENBQUM7WUFDM0QsT0FBTztTQUNSO1FBRUQsd0VBQXdFO1FBQ3hFLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtZQUMvQixJQUFNLFVBQVEsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqRCxZQUFZLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLFVBQVEsRUFBRSxVQUFRLENBQUMsQ0FBQztZQUMzRCxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDNUIsT0FBTztTQUNSO1FBRUQsd0RBQXdEO1FBQ3hELElBQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqRSxJQUNFLFlBQVksR0FBRyxDQUFDO1lBQ2hCLGNBQWM7WUFDZCxjQUFjLENBQUMsTUFBTSxHQUFHLFlBQVksRUFDcEM7WUFDQSxJQUFNLGNBQWMsR0FBRyxVQUFHLFVBQVUsQ0FDbEMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQ2xDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JDLElBQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsbUJBQW1CO1lBQzlFLElBQU0sVUFBUSxHQUNaLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsd0JBQXdCO2dCQUNuRCxDQUFDLEdBQUcsY0FBYztnQkFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxHQUFHLHVDQUF1QztnQkFDekUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsdUNBQXVDO1lBQzNFLFlBQVksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsVUFBUSxFQUFFLFVBQVEsQ0FBQyxDQUFDO1lBQzNELFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUM1QixPQUFPO1NBQ1I7UUFFRCxJQUFNLFFBQVEsR0FDWixVQUFHLFVBQVUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFFLENBQUMsTUFBTTtZQUN6RCxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDM0QsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzlCLENBQUMsRUFBRSxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBRS9CLDREQUE0RDtJQUM1RCxJQUFNLFdBQVcsR0FBRyxlQUFLLENBQUMsV0FBVyxDQUFDO1FBQ3BDLDBCQUEwQjtRQUMxQixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRTtZQUN6QixPQUFPO1NBQ1I7UUFDRCxJQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDN0QsSUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFbEQsb0RBQW9EO1FBQ3BELFlBQVksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQ3BDLFVBQVUsRUFDVixVQUFVLEdBQUcsV0FBVyxDQUN6QixDQUFDO0lBQ0osQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUVyQiw2RkFBNkY7SUFDN0YsSUFBTSxVQUFVLEdBQUcsVUFBQyxLQUF5QztRQUMzRCxJQUFNLFFBQVEsR0FBRyxVQUFVLENBQ3pCLElBQUksQ0FBQyxHQUFHLENBQ04sSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFDOUQsR0FBRyxDQUNKLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUN4QixDQUFDO1FBQ0YsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDcEMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUIsQ0FBQyxDQUFDO0lBRUYsT0FBTyxDQUNMLDhCQUFDLHFCQUFTLGVBQ0osS0FBSyxJQUNULFNBQVMsRUFBRSxJQUFBLGNBQUksRUFBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxFQUM3QyxLQUFLLEVBQUUsY0FBYyxFQUNyQixHQUFHLEVBQUUsR0FBRyxFQUNSLEdBQUcsRUFBRSxHQUFHLEVBQ1IsUUFBUSxFQUFFLGlCQUFpQixFQUMzQixPQUFPLEVBQUUsV0FBVyxFQUNwQixNQUFNLEVBQUUsVUFBVSxFQUNsQixHQUFHLEVBQUUsWUFBWSxJQUNqQixDQUNILENBQUM7QUFDSixDQUFDLENBQUM7QUFqSlcsUUFBQSxxQkFBcUIseUJBaUpoQztBQVlLLElBQU0sa0JBQWtCLEdBQXNDLFVBQ25FLEtBQUs7SUFFTCxPQUFPLENBQ0wsOEJBQUMsNkJBQXFCLGVBQUssS0FBSyxJQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQ3hFLENBQUM7QUFDSixDQUFDLENBQUM7QUFOVyxRQUFBLGtCQUFrQixzQkFNN0I7QUFlSyxJQUFNLGdCQUFnQixHQUFvQyxVQUFDLEtBQUs7SUFDN0QsSUFBQSxLQUFLLEdBQXdDLEtBQUssTUFBN0MsRUFBRSxRQUFRLEdBQThCLEtBQUssU0FBbkMsRUFBRSxHQUFHLEdBQXlCLEtBQUssSUFBOUIsRUFBRSxHQUFHLEdBQW9CLEtBQUssSUFBekIsRUFBSyxVQUFVLFVBQUssS0FBSyxFQUFwRCxtQ0FBNEMsQ0FBRixDQUFXO0lBQzNELElBQ0UsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztRQUN4QixDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQy9CO1FBQ0EsTUFBTSxJQUFJLEtBQUssQ0FBQywwREFBMEQsQ0FBQyxDQUFDO0tBQzdFO0lBQ0QsT0FBTyxDQUNMLDhCQUFDLDZCQUFxQixhQUNwQixLQUFLLEVBQUUsS0FBSyxHQUFHLEdBQUcsRUFDbEIsUUFBUSxFQUFFLFVBQUMsR0FBRyxJQUFLLE9BQUEsUUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsRUFBbkIsQ0FBbUIsRUFDdEMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUNoQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQzVCLFVBQVUsSUFDZCxXQUFXLEVBQUUsSUFBSSxFQUNqQixLQUFLLEVBQUUsR0FBRyxFQUNWLFlBQVksRUFBRSxDQUFDLElBQ2YsQ0FDSCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBckJXLFFBQUEsZ0JBQWdCLG9CQXFCM0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ2hhbmdlRXZlbnQsIHVzZUVmZmVjdCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IFRleHRGaWVsZFByb3BzLCBUZXh0RmllbGQgfSBmcm9tICcuLi9UZXh0RmllbGQnO1xuXG5pbXBvcnQgeyBtYWtlU3R5bGVzIH0gZnJvbSAnLi4vLi4vc3R5bGVzJztcbmltcG9ydCBjbHN4IGZyb20gJ2Nsc3gnO1xuaW1wb3J0IHsgR2V0Q2xhc3NlcyB9IGZyb20gJy4uLy4uL3R5cGVVdGlscyc7XG5cbmV4cG9ydCBjb25zdCBVbml0TnVtYmVyRm9ybWF0RmllbGRTdHlsZXNLZXkgPSAnQ2hyb21hVW5pdE51bWJlckZvcm1hdEZpZWxkJztcblxuY29uc3QgdXNlU3R5bGVzID0gbWFrZVN0eWxlcyhcbiAgKHRoZW1lKSA9PiAoe1xuICAgIHRleHRGaWVsZDoge1xuICAgICAgbWFyZ2luVG9wOiB0aGVtZS5zcGFjaW5nKDIpLFxuICAgICAgbWFyZ2luQm90dG9tOiB0aGVtZS5zcGFjaW5nKDEpLFxuICAgIH0sXG4gIH0pLFxuICB7IG5hbWU6IFVuaXROdW1iZXJGb3JtYXRGaWVsZFN0eWxlc0tleSB9XG4pO1xuXG5leHBvcnQgdHlwZSBVbml0TnVtYmVyRm9ybWF0RmllbGRDbGFzc2VzID0gR2V0Q2xhc3Nlczx0eXBlb2YgdXNlU3R5bGVzPjtcblxuZXhwb3J0IHR5cGUgVW5pdE51bWJlckZvcm1hdEZpZWxkUHJvcHMgPSBPbWl0PFxuICBUZXh0RmllbGRQcm9wcyxcbiAgJ29uQ2hhbmdlJyB8ICd2YWx1ZSdcbj4gJiB7XG4gIG1pbj86IG51bWJlcjtcbiAgbWF4PzogbnVtYmVyO1xuICB2YWx1ZTogbnVtYmVyO1xuICB1bml0czogc3RyaW5nO1xuICBkZWNpbWFsU2NhbGU/OiBudW1iZXI7XG4gIHByZWZpeFVuaXRzPzogYm9vbGVhbjtcbiAgb25DaGFuZ2U6ICh2YWw6IG51bWJlcikgPT4gdm9pZDtcbn07XG5cbmV4cG9ydCBjb25zdCBVbml0TnVtYmVyRm9ybWF0RmllbGQ6IFJlYWN0LkZDPFVuaXROdW1iZXJGb3JtYXRGaWVsZFByb3BzPiA9IChcbiAgcHJvcHNcbikgPT4ge1xuICBjb25zdCB7XG4gICAgb25DaGFuZ2UsXG4gICAgb25CbHVyLFxuICAgIHZhbHVlLFxuICAgIG1pbiA9IDAsXG4gICAgbWF4ID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsXG4gICAgdW5pdHMsXG4gICAgZGVjaW1hbFNjYWxlID0gMCxcbiAgICBwcmVmaXhVbml0cyA9IGZhbHNlLFxuICAgIGNsYXNzTmFtZSxcbiAgICAuLi5vdGhlclxuICB9ID0gcHJvcHM7XG4gIC8vIGZvcm1hdHRpbmcgaGVscGVyLiBQcmVmaXhlcyB1bml0cyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBzdWZmaXguXG4gIC8vIGFsc28gYXV0b21hdGljYWxseSBhZGRzIGEgc3BhY2UgaWYgdGhlIHVuaXRzIHN0cmluZyBpcyA+IDIgZS5nICQxMC4wMCAzMCUsIDEybWwsIDEwIHNsb3RzXG4gIGNvbnN0IGZvcm1hdCA9ICh2YWw6IG51bWJlcikgPT5cbiAgICBwcmVmaXhVbml0c1xuICAgICAgPyBgJHt1bml0c30ke3ZhbC50b0ZpeGVkKGRlY2ltYWxTY2FsZSl9YFxuICAgICAgOiBgJHt2YWwudG9GaXhlZChkZWNpbWFsU2NhbGUpfSR7dW5pdHMubGVuZ3RoID4gMiA/ICcgJyA6ICcnfSR7dW5pdHN9YDtcbiAgY29uc3QgW3RleHRGaWVsZFZhbHVlLCBzZXRUZXh0RmllbGRWYWx1ZV0gPSBSZWFjdC51c2VTdGF0ZShmb3JtYXQodmFsdWUpKTtcblxuICBjb25zdCBjbGFzc2VzID0gdXNlU3R5bGVzKHt9KTtcblxuICBjb25zdCBbcmF3VmFsdWUsIHNldFJhd1ZhbHVlXSA9IFJlYWN0LnVzZVN0YXRlKGZvcm1hdCh2YWx1ZSkpO1xuXG4gIC8vIHdoZW4gdGhlIHRleHQgaW5wdXQgY2hhbmdlcywgY2FsbCBvbkNoYW5nZSBoYW5kbGVyXG4gIGNvbnN0IGhhbmRsZVZhbHVlQ2hhbmdlID0gKHZhbHVlOiBDaGFuZ2VFdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT4ge1xuICAgIGNvbnN0IHJhd05ld1ZhbHVlID0gdmFsdWUudGFyZ2V0LnZhbHVlO1xuXG4gICAgLy8gdXNlciBkZWxldGVkIHZhbHVlLCBzZXQgdGV4dCBmaWVsZCB2YWx1ZSB3aXRob3V0IHVwZGF0aW5nIHVuZGVybHlpbmcgdmFsdWVcbiAgICBpZiAocmF3TmV3VmFsdWUudHJpbSgpID09PSB1bml0cykge1xuICAgICAgc2V0VGV4dEZpZWxkVmFsdWUocmF3TmV3VmFsdWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHNldFJhd1ZhbHVlKHJhd05ld1ZhbHVlKTtcblxuICAgIC8vIGRlZmF1bHQgdG8gMCB0byBoYW5kbGUgZ2FyYmFnZSBOYU4gaW5wdXRcbiAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlRmxvYXQoXG4gICAgICAocGFyc2VGbG9hdChyYXdOZXdWYWx1ZS5yZXBsYWNlKHVuaXRzLCAnJykpIHx8IDApLnRvRml4ZWQoZGVjaW1hbFNjYWxlKVxuICAgICk7XG4gICAgc2V0VGV4dEZpZWxkVmFsdWUoZm9ybWF0KG5ld1ZhbHVlKSk7XG4gICAgb25DaGFuZ2UobmV3VmFsdWUpO1xuICB9O1xuXG4gIC8vIHdoZW4gdGhlIHByb3ZpZGVkIHZhbHVlIGNoYW5nZXMsIHVwZGF0ZSB0aGUgZGlzcGxheWVkIHZhbHVlXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgc2V0VGV4dEZpZWxkVmFsdWUoZm9ybWF0KHZhbHVlKSk7XG4gIH0sIFt2YWx1ZV0pO1xuXG4gIGNvbnN0IHRleHRGaWVsZFJlZiA9IFJlYWN0LnVzZVJlZjxIVE1MSW5wdXRFbGVtZW50IHwgbnVsbD4obnVsbCk7XG5cbiAgLy8gVGhpcyB1c2VFZmZlY3Qga2VlcHMgdGhlIHBvc2l0aW9uIG9mIHRoZSBjdXJzb3IgZnJvbSBqdW1waW5nIGFmdGVyIHRoZSB2YWx1ZSBpcyBmb3JtYXR0ZWRcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAodGV4dEZpZWxkVmFsdWUgPT09IHJhd1ZhbHVlIHx8ICF0ZXh0RmllbGRSZWYuY3VycmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHVzZXIgZGVsZXRlZCB2YWx1ZSwgc2V0IGN1cnNvciBiZXNpZGUgdW5pdHNcbiAgICBpZiAodGV4dEZpZWxkVmFsdWUudHJpbSgpID09PSB1bml0cykge1xuICAgICAgY29uc3QgcG9zaXRpb24gPSBwcmVmaXhVbml0cyA/IHVuaXRzLmxlbmd0aCA6IDA7XG4gICAgICB0ZXh0RmllbGRSZWYuY3VycmVudC5zZXRTZWxlY3Rpb25SYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHVzZXIgdHlwZWQgYSBkZWNpbWFsIG5leHQgdG8gYSBkZWNpbWFsLCBtb3ZlIGN1cnNvciBhbmQgdGhyb3cgaXQgYXdheVxuICAgIGlmIChyYXdWYWx1ZS5pbmRleE9mKCcuLicpID4gLTEpIHtcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGV4dEZpZWxkVmFsdWUuaW5kZXhPZignLicpICsgMTtcbiAgICAgIHRleHRGaWVsZFJlZi5jdXJyZW50LnNldFNlbGVjdGlvblJhbmdlKHBvc2l0aW9uLCBwb3NpdGlvbik7XG4gICAgICBzZXRSYXdWYWx1ZSh0ZXh0RmllbGRWYWx1ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gaGFuZGxlIHBvc2l0aW9uaW5nIGN1cnNvciB3aGVuIHR5cGluZyBpbiBkZWNpbWFsIHBhcnRcbiAgICBjb25zdCByYXdEZWNpbWFsUGFydCA9IHJhd1ZhbHVlLnJlcGxhY2UodW5pdHMsICcnKS5zcGxpdCgnLicpWzFdO1xuICAgIGlmIChcbiAgICAgIGRlY2ltYWxTY2FsZSA+IDAgJiZcbiAgICAgIHJhd0RlY2ltYWxQYXJ0ICYmXG4gICAgICByYXdEZWNpbWFsUGFydC5sZW5ndGggPiBkZWNpbWFsU2NhbGVcbiAgICApIHtcbiAgICAgIGNvbnN0IHJhd051bWJlclBhcnRzID0gYCR7cGFyc2VGbG9hdChcbiAgICAgICAgdGV4dEZpZWxkVmFsdWUucmVwbGFjZSh1bml0cywgJycpXG4gICAgICApLnRvRml4ZWQoZGVjaW1hbFNjYWxlKX1gLnNwbGl0KCcuJyk7XG4gICAgICBjb25zdCBkZWNpbWFsUGFydCA9IHJhd051bWJlclBhcnRzWzFdLnJlcGxhY2UoLzArJC9nLCAnJyk7IC8vIHRyaW0gdHJhaWxpbmcgMHNcbiAgICAgIGNvbnN0IHBvc2l0aW9uID1cbiAgICAgICAgcmF3TnVtYmVyUGFydHNbMF0ubGVuZ3RoICsgLy8gbGVuZ3RoIGJlZm9yZSBkZWNpbWFsXG4gICAgICAgIDEgKyAvLyB0aGUgZGVjaW1hbFxuICAgICAgICBNYXRoLm1heChkZWNpbWFsUGFydC5sZW5ndGgsIDEpICsgLy8gYXQgbGVhc3Qgb25lIGNoYXJhY3RlciBhZnRlciBkZWNpbWFsXG4gICAgICAgIChwcmVmaXhVbml0cyA/IHVuaXRzLmxlbmd0aCA6IDApOyAvLyBsZW5ndGggb2YgdW5pdHMsIGlmIHRoZXkncmUgcHJlZml4ZWRcbiAgICAgIHRleHRGaWVsZFJlZi5jdXJyZW50LnNldFNlbGVjdGlvblJhbmdlKHBvc2l0aW9uLCBwb3NpdGlvbik7XG4gICAgICBzZXRSYXdWYWx1ZSh0ZXh0RmllbGRWYWx1ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcG9zaXRpb24gPVxuICAgICAgYCR7cGFyc2VGbG9hdCh0ZXh0RmllbGRWYWx1ZS5yZXBsYWNlKHVuaXRzLCAnJykpfWAubGVuZ3RoICtcbiAgICAgIChwcmVmaXhVbml0cyA/IHVuaXRzLmxlbmd0aCA6IDApO1xuICAgIHRleHRGaWVsZFJlZi5jdXJyZW50LnNldFNlbGVjdGlvblJhbmdlKHBvc2l0aW9uLCBwb3NpdGlvbik7XG4gICAgc2V0UmF3VmFsdWUodGV4dEZpZWxkVmFsdWUpO1xuICB9LCBbdGV4dEZpZWxkVmFsdWUsIHJhd1ZhbHVlXSk7XG5cbiAgLy8gaGFuZGxlcyBzZWxlY3RpbmcganVzdCB0aGUgdmFsdWUgKG5vdCB0aGUgdW5pdHMpIG9uIGZvY3VzXG4gIGNvbnN0IGhhbmRsZUZvY3VzID0gUmVhY3QudXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgaWYgKCF0ZXh0RmllbGRSZWYuY3VycmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpbnB1dExlbmd0aCA9IHRleHRGaWVsZFZhbHVlLnJlcGxhY2UodW5pdHMsICcnKS5sZW5ndGg7XG4gICAgY29uc3QgaW5wdXRTdGFydCA9IHByZWZpeFVuaXRzID8gdW5pdHMubGVuZ3RoIDogMDtcblxuICAgIC8vIGZvY3VzIGNhbiBvbmx5IGZpcmUgaWYgdGhlIGlucHV0IHJlZiBoYXMgYmVlbiBzZXRcbiAgICB0ZXh0RmllbGRSZWYuY3VycmVudC5zZXRTZWxlY3Rpb25SYW5nZShcbiAgICAgIGlucHV0U3RhcnQsXG4gICAgICBpbnB1dFN0YXJ0ICsgaW5wdXRMZW5ndGhcbiAgICApO1xuICB9LCBbdGV4dEZpZWxkVmFsdWVdKTtcblxuICAvLyBpZiB0aGUgdXNlciBkZWxldGVkIHZhbHVlIGFuZCBsZWZ0IG9ubHkgdW5pdHMsIHRoaXMgcmVzdG9yZXMgdGhlIHRleHQgZmllbGQgdG8gdmFsaWQgdmFsdWVcbiAgY29uc3QgaGFuZGxlQmx1ciA9IChldmVudDogUmVhY3QuRm9jdXNFdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT4ge1xuICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGbG9hdChcbiAgICAgIE1hdGgubWF4KFxuICAgICAgICBNYXRoLm1pbihwYXJzZUZsb2F0KHJhd1ZhbHVlLnJlcGxhY2UodW5pdHMsICcnKSksIE51bWJlcihtYXgpKSxcbiAgICAgICAgbWluXG4gICAgICApLnRvRml4ZWQoZGVjaW1hbFNjYWxlKVxuICAgICk7XG4gICAgc2V0VGV4dEZpZWxkVmFsdWUoZm9ybWF0KG5ld1ZhbHVlKSk7XG4gICAgb25DaGFuZ2UobmV3VmFsdWUpO1xuICAgIG9uQmx1ciAmJiBvbkJsdXIoZXZlbnQpO1xuICB9O1xuXG4gIHJldHVybiAoXG4gICAgPFRleHRGaWVsZFxuICAgICAgey4uLm90aGVyfVxuICAgICAgY2xhc3NOYW1lPXtjbHN4KGNsYXNzZXMudGV4dEZpZWxkLCBjbGFzc05hbWUpfVxuICAgICAgdmFsdWU9e3RleHRGaWVsZFZhbHVlfVxuICAgICAgbWluPXttaW59XG4gICAgICBtYXg9e21heH1cbiAgICAgIG9uQ2hhbmdlPXtoYW5kbGVWYWx1ZUNoYW5nZX1cbiAgICAgIG9uRm9jdXM9e2hhbmRsZUZvY3VzfVxuICAgICAgb25CbHVyPXtoYW5kbGVCbHVyfVxuICAgICAgcmVmPXt0ZXh0RmllbGRSZWZ9XG4gICAgLz5cbiAgKTtcbn07XG5cbmV4cG9ydCB0eXBlIFBlcmNlbnRGb3JtYXRGaWVsZFByb3BzID0gT21pdDxcbiAgVGV4dEZpZWxkUHJvcHMsXG4gICdvbkNoYW5nZScgfCAndmFsdWUnXG4+ICYge1xuICBtaW4/OiBudW1iZXI7XG4gIG1heD86IG51bWJlcjtcbiAgdmFsdWU6IG51bWJlcjtcbiAgb25DaGFuZ2U6ICh2YWw6IG51bWJlcikgPT4gdm9pZDtcbn07XG5cbmV4cG9ydCBjb25zdCBQZXJjZW50Rm9ybWF0RmllbGQ6IFJlYWN0LkZDPFBlcmNlbnRGb3JtYXRGaWVsZFByb3BzPiA9IChcbiAgcHJvcHNcbikgPT4ge1xuICByZXR1cm4gKFxuICAgIDxVbml0TnVtYmVyRm9ybWF0RmllbGQgey4uLnByb3BzfSB1bml0cz17JyUnfSBtYXg9e3Byb3BzLm1heCB8fCAxMDB9IC8+XG4gICk7XG59O1xuXG4vKipcbiAqIEBwYXJhbSBwcm9wcyBBbGwgY3VycmVuY3kgdmFsdWVzIGFyZSBleHBlY3RlZCB0byBiZSBhbiBpbnRlZ2VyIGFtb3VudCBvZiBwZW5uaWVzXG4gKi9cblxuZXhwb3J0IHR5cGUgUHJpY2VGb3JtYXRGaWVsZFByb3BzID0gT21pdDxcbiAgVGV4dEZpZWxkUHJvcHMsXG4gICdvbkNoYW5nZScgfCAndmFsdWUnXG4+ICYge1xuICBtaW4/OiBudW1iZXI7XG4gIG1heD86IG51bWJlcjtcbiAgdmFsdWU6IG51bWJlcjtcbiAgb25DaGFuZ2U6ICh2YWw6IG51bWJlcikgPT4gdm9pZDtcbn07XG5leHBvcnQgY29uc3QgUHJpY2VGb3JtYXRGaWVsZDogUmVhY3QuRkM8UHJpY2VGb3JtYXRGaWVsZFByb3BzPiA9IChwcm9wcykgPT4ge1xuICBjb25zdCB7IHZhbHVlLCBvbkNoYW5nZSwgbWluLCBtYXgsIC4uLm90aGVyUHJvcHMgfSA9IHByb3BzO1xuICBpZiAoXG4gICAgIU51bWJlci5pc0ludGVnZXIodmFsdWUpIHx8XG4gICAgKG1pbiAmJiAhTnVtYmVyLmlzSW50ZWdlcihtaW4pKSB8fFxuICAgIChtYXggJiYgIU51bWJlci5pc0ludGVnZXIobWF4KSlcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb24taW50ZWdlciBhbW91bnQgb2YgcGVubmllcyBwYXNzZWQgdG8gUHJpY2VGb3JtYXRGaWVsZCcpO1xuICB9XG4gIHJldHVybiAoXG4gICAgPFVuaXROdW1iZXJGb3JtYXRGaWVsZFxuICAgICAgdmFsdWU9e3ZhbHVlIC8gMTAwfSAvLyBWYWx1ZSBpbiBwZW5uaWVzIGNvbnZlcnRlZCB0byBkb2xsYXJzXG4gICAgICBvbkNoYW5nZT17KHZhbCkgPT4gb25DaGFuZ2UodmFsICogMTAwKX0gLy8gRG9sbGFyIGNvbnZlcnRlZCB0byBleHBlY3RlZCBwZW5uaWVzXG4gICAgICBtaW49e21pbiA/IG1pbiAvIDEwMCA6IHVuZGVmaW5lZH0gLy8gTWluIGluIHBlbm5pZXMgY29udmVydGVkIHRvIGRvbGxhcnNcbiAgICAgIG1heD17bWF4ID8gbWF4IC8gMTAwIDogdW5kZWZpbmVkfSAvLyBNYXggaW4gcGVubmllcyBjb252ZXJ0ZWQgdG8gZG9sbGFyc1xuICAgICAgey4uLm90aGVyUHJvcHN9XG4gICAgICBwcmVmaXhVbml0cz17dHJ1ZX1cbiAgICAgIHVuaXRzPXsnJCd9XG4gICAgICBkZWNpbWFsU2NhbGU9ezJ9XG4gICAgLz5cbiAgKTtcbn07XG4iXX0=